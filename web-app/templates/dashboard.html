<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Keystroke Dynamics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div style="padding: 24px 20px; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-fingerprint" style="color: white; font-size: 18px;"></i>
                </div>
                <div>
                    <div class="logo-text">Keystroke Auth</div>
                    <div style="font-size: 11px; color: #64748b;">Biyometrik Doğrulama</div>
                </div>
            </div>
        </div>
        
        <nav style="padding: 16px 12px; flex: 1;">
            <a href="/dashboard" class="nav-item active">
                <i class="fas fa-th-large" style="width: 20px;"></i>
                <span style="font-size: 14px; font-weight: 500;">Dashboard</span>
            </a>
            <a href="/" class="nav-item">
                <i class="fas fa-keyboard" style="width: 20px;"></i>
                <span style="font-size: 14px; font-weight: 500;">Yeni Doğrulama</span>
            </a>
        </nav>
        
        <div style="padding: 20px; border-top: 1px solid rgba(148, 163, 184, 0.1);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div class="user-avatar" id="avatar">U</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="sidebarUser">Kullanıcı</div>
                    <div style="font-size: 12px; color: #34d399; display: flex; align-items: center; gap: 6px;">
                        <span style="width: 6px; height: 6px; background: #34d399; border-radius: 50%;"></span>
                        Aktif Oturum
                    </div>
                </div>
            </div>
            <button onclick="logout()" class="btn btn-ghost" style="width: 100%; justify-content: center;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Çıkış Yap</span>
            </button>
        </div>
    </div>

    <div class="main">
        <header class="header">
            <div style="padding: 16px 28px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button class="mobile-menu" onclick="document.getElementById('sidebar').classList.toggle('open')">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 style="font-size: 20px; font-weight: 700;">Dashboard</h1>
                        <p style="font-size: 13px; color: #64748b; margin-top: 2px;">Hoş geldin, <span style="color: #94a3b8; font-weight: 500;" id="headerUser">kullanıcı</span></p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="font-size: 13px; color: #64748b; display: flex; align-items: center; gap: 8px;">
                        <i class="far fa-calendar-alt"></i>
                        <span id="datetime"></span>
                    </div>
                    <a href="/" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        <span>Yeni Giriş</span>
                    </a>
                </div>
            </div>
        </header>

        <div style="padding: 28px;">
            <!-- Stats -->
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 28px;">
                <div class="card stat-card blue" style="padding: 24px;">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 13px; color: #64748b; font-weight: 500; margin-bottom: 8px;">Toplam Oturum</div>
                            <div class="mono" style="font-size: 32px; font-weight: 700;" id="totalSessions">0</div>
                        </div>
                        <div class="icon-box blue">
                            <i class="fas fa-history"></i>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #64748b;">
                        <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                        Tüm giriş denemeleri
                    </div>
                </div>
                
                <div class="card stat-card green" style="padding: 24px;">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 13px; color: #64748b; font-weight: 500; margin-bottom: 8px;">Ort. Doğruluk</div>
                            <div class="mono" style="font-size: 32px; font-weight: 700;" id="avgAccuracy">-</div>
                        </div>
                        <div class="icon-box green">
                            <i class="fas fa-bullseye"></i>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #64748b;">
                        <i class="fas fa-chart-line" style="margin-right: 4px;"></i>
                        Yazım doğruluğu
                    </div>
                </div>
                
                <div class="card stat-card purple" style="padding: 24px;">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 13px; color: #64748b; font-weight: 500; margin-bottom: 8px;">Ort. Hız</div>
                            <div class="mono" style="font-size: 32px; font-weight: 700;" id="avgWPM">-</div>
                        </div>
                        <div class="icon-box purple">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #64748b;">
                        <i class="fas fa-keyboard" style="margin-right: 4px;"></i>
                        Kelime/dakika
                    </div>
                </div>
                
                <div class="card stat-card amber" style="padding: 24px;">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 13px; color: #64748b; font-weight: 500; margin-bottom: 8px;">Başarı Oranı</div>
                            <div class="mono" style="font-size: 32px; font-weight: 700;" id="successRate">-</div>
                        </div>
                        <div class="icon-box amber">
                            <i class="fas fa-check-double"></i>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #64748b;">
                        <i class="fas fa-trophy" style="margin-right: 4px;"></i>
                        Başarılı girişler
                    </div>
                </div>
            </div>

            <!-- Chart & Activity -->
            <div class="content-grid" style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 28px;">
                <div class="card" style="padding: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                        <div>
                            <div style="font-size: 16px; font-weight: 600;">Doğruluk Grafiği</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Son oturumların doğruluk oranları</div>
                        </div>
                    </div>
                    <div style="height: 220px;">
                        <canvas id="chart"></canvas>
                    </div>
                </div>
                
                <div class="card" style="padding: 24px;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 600;">Son Girişler</div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 4px;">En son 5 giriş denemesi</div>
                    </div>
                    <div id="recentList" style="display: flex; flex-direction: column; gap: 10px;">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <div style="font-size: 14px; font-weight: 500;">Henüz giriş yok</div>
                            <div style="font-size: 12px; margin-top: 4px;">İlk girişinizi yapın</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card" style="overflow: hidden;">
                <div style="padding: 20px 24px; border-bottom: 1px solid rgba(148, 163, 184, 0.1); display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-size: 16px; font-weight: 600;">Oturum Geçmişi</div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Tüm doğrulama kayıtları</div>
                    </div>
                    <button class="btn btn-ghost" onclick="exportCSV()">
                        <i class="fas fa-download"></i>
                        <span>CSV İndir</span>
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="border-radius: 0;">Tarih & Saat</th>
                                <th>Oturum Tipi</th>
                                <th>Doğruluk</th>
                                <th>Yazma Hızı</th>
                                <th style="border-radius: 0;">Durum</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <i class="fas fa-folder-open"></i>
                                    <div style="font-size: 14px; font-weight: 500;">Henüz oturum kaydı yok</div>
                                    <div style="font-size: 12px; margin-top: 4px;">Giriş yaptığınızda kayıtlar burada görünecek</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let username = '';
        let userData = null;
        let chart = null;

        async function init() {
            try {
                const res = await fetch('/api/me');
                if (!res.ok) { window.location.href = '/'; return; }
                const data = await res.json();
                username = data.username;
                
                document.getElementById('avatar').textContent = username.charAt(0).toUpperCase();
                document.getElementById('sidebarUser').textContent = username;
                document.getElementById('headerUser').textContent = username;
                
                await loadData();
            } catch (e) {
                window.location.href = '/';
            }
        }

        async function loadData() {
            try {
                const res = await fetch('/api/user-stats');
                if (!res.ok) { if (res.status === 401) window.location.href = '/'; return; }
                userData = await res.json();
                render();
            } catch (e) {
                console.error(e);
            }
        }

        function render() {
            const d = userData;
            
            document.getElementById('totalSessions').textContent = d.total_sessions || 0;
            document.getElementById('avgAccuracy').textContent = d.avg_accuracy > 0 ? d.avg_accuracy.toFixed(1) + '%' : '-';
            document.getElementById('avgWPM').textContent = d.avg_wpm > 0 ? Math.round(d.avg_wpm) + ' WPM' : '-';
            
            const success = d.sessions.filter(s => s.status === 'success').length;
            const rate = d.total_sessions > 0 ? Math.round(success / d.total_sessions * 100) : 0;
            document.getElementById('successRate').textContent = d.total_sessions > 0 ? rate + '%' : '-';

            // Recent
            const recent = document.getElementById('recentList');
            if (d.sessions.length === 0) {
                recent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <div style="font-size: 14px; font-weight: 500;">Henüz giriş yok</div>
                        <div style="font-size: 12px; margin-top: 4px;">İlk girişinizi yapın</div>
                    </div>
                `;
            } else {
                recent.innerHTML = d.sessions.slice(0, 5).map(s => `
                    <div class="activity-item">
                        <div class="activity-icon ${s.status === 'success' ? 'success' : 'error'}">
                            <i class="fas fa-${s.status === 'success' ? 'check' : 'times'}"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 600;">${s.type}</div>
                            <div style="font-size: 11px; color: #64748b;">${s.date}</div>
                        </div>
                        <span class="badge ${s.status === 'success' ? 'badge-success' : 'badge-error'}">${s.accuracy}%</span>
                    </div>
                `).join('');
            }

            // Table
            const tbody = document.getElementById('tableBody');
            if (d.sessions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <div style="font-size: 14px; font-weight: 500;">Henüz oturum kaydı yok</div>
                            <div style="font-size: 12px; margin-top: 4px;">Giriş yaptığınızda kayıtlar burada görünecek</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = d.sessions.map(s => `
                    <tr>
                        <td style="font-weight: 500;">${s.date}</td>
                        <td><span class="badge badge-info">${s.type}</span></td>
                        <td><span class="mono" style="font-weight: 600;">${s.accuracy}%</span></td>
                        <td><span class="mono">${s.wpm} WPM</span></td>
                        <td>
                            <span class="badge ${s.status === 'success' ? 'badge-success' : 'badge-error'}">
                                <i class="fas fa-${s.status === 'success' ? 'check' : 'times'}"></i>
                                ${s.status === 'success' ? 'Başarılı' : 'Başarısız'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }

            renderChart(d.accuracy_trend || []);
        }

        function renderChart(data) {
            if (chart) chart.destroy();
            
            const ctx = document.getElementById('chart').getContext('2d');
            const labels = data.length > 0 ? data.map((_, i) => `Oturum ${i + 1}`) : [''];
            const values = data.length > 0 ? data : [0];
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 220);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#1e293b',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#e2e8f0',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(148, 163, 184, 0.2)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: ctx => `Doğruluk: ${ctx.parsed.y}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            ticks: {
                                color: '#64748b',
                                font: { size: 11 },
                                callback: v => v + '%'
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.08)' }
                        },
                        x: {
                            ticks: {
                                color: '#64748b',
                                font: { size: 11 }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function exportCSV() {
            if (!userData || userData.sessions.length === 0) {
                alert('Dışa aktarılacak veri yok');
                return;
            }
            
            let csv = 'Tarih,Tip,Doğruluk,Hız,Durum\n';
            csv += userData.sessions.map(s => 
                `${s.date},${s.type},${s.accuracy}%,${s.wpm} WPM,${s.status === 'success' ? 'Başarılı' : 'Başarısız'}`
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `oturumlar_${username}.csv`;
            link.click();
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('datetime').textContent = now.toLocaleString('tr-TR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        updateDateTime();
        setInterval(updateDateTime, 60000);
        init();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
